<fieldset class="ui-corner-all ui-widget-content">
    <legend><b>Seleccione los feeds a publicar</b></legend>
    <table border="1">
        <tr>
            <th>Categoría</th>
            <th>Items<br>seleccionados</th>
            <th>RSS</th>
        </tr>
        <tr>
            <th></th>
            <th></th>
            <th>
                <table border="0">
                    <tr>
                        <th width="40px"></th>
                        <th width="350px">URL del RSS</th>
                        <th width="30px">Límite</th>
                    </tr>
                </table>
            </th>
            <!--<th>Publicar<br>fecha</th>
            <th>Publicar<br>hora</th>
            <th>Limite</th>
            <th>Fecha inicio</th>
            <th>Fecha fin</th>-->
        </tr>
        <tr>
            <?php
            $categoriafeeds= new Categoriafeeds();
            $buscaCategoriafeeds= $categoriafeeds->Find();
            $i=0;
            foreach ($buscaCategoriafeeds as $result) {
                $i++;
                $categoria_id=$result->getId();
                $nombreCategoria=$result->getNombreCategoria();
                echo "<tr><td>$nombreCategoria</td>";
                echo "<td>".Tag::textField("total_feeds_$categoria_id","value: 0","size: 2px","readonly: readonly","style: background-color: #ccc").Tag::textField("seleccionados_$categoria_id","size: 10px","readonly: readonly","style: background-color: #ccc")."</td>";
                echo "<td>";
                echo "<a href='#' onclick='abrir_div_feeds($categoria_id)'>".Tag::image('abrir.png','title: Ver feeds de esta categoria','width: 15','border: 0')."</a>";
                echo "<a href='#' onclick='cerrar_div_feeds($categoria_id)'>".Tag::image('cerrar.png','title: Ocultar feeds de esta categoria','width: 15','border: 0')."</a>";

                //echo "<td><input type='button' value='Ver' style='width:35px' title='Ver feeds de esta categoria' onclick='abrir_div_feeds($categoria_id)'>
                //    <input type='button' value='Ocultar' style='width:50px' title='Ocultar feeds de esta categoria' onclick='cerrar_div_feeds($categoria_id)'>";
                echo "&nbsp;&nbsp;|&nbsp;&nbsp;<a href='#' onclick='check_all_feeds($categoria_id)'>".Tag::image('check_all.gif','title: Seleccionar todos los feeds','width: 15','border: 0')."</a>";
                echo "<a href='#' onclick='uncheck_all_feeds($categoria_id)'>".Tag::image('uncheck_all.gif','title: Deseleccionar todos los feeds','width: 15','border: 0')."</a>";
                //echo "&nbsp;&nbsp;|&nbsp;&nbsp;<input type='button' value='Seleccionar todos' title='Seleccionar todos los feeds' onclick='check_all_feeds($categoria_id)'>
                //    <input type='button' value='Deseleccionar todos' title='Deseleccionar todos los feeds' onclick='uncheck_all_feeds($categoria_id)'> <br>";
                echo "<div id='div_feeds_$categoria_id' name='div_feeds_$categoria_id'>";
                echo "<table border='0'>";

                $array_feeds=array();
                if($id!=null) {
                    //INICIO VER LOS RSS ASIGNADOS
                    $condicion = "{#Pantallafeed}.pantalla_id = $id AND {#Pantallafeed}.categoriafeeds_id = $categoria_id";
                    $query = new ActiveRecordJoin(array(
                                    "entities" => array("Feed", "Pantallafeed"),
                                    "fields" => array(
                                            "{#Feed}.id",
                                            "{#Feed}.url_feed",
                                            "{#Pantallafeed}.limite_items"),
                                    "conditions" => $condicion
                            //"order"=> "{#Pantallavideos}.orden"
                    ));
                    foreach($query->getResultSet() as $result) {
                        $feed_id= $result->getId();
                        $ulrFeed= $result->getUrlFeed();
                        echo "<tr>";
                        echo "<td width='40px' style='padding-left:8px; padding-right:8px'><input type='checkbox' id='chk_feed' name='chk_feed' value='$feed_id' class='c_feed_$categoria_id' onclick='seleccionar($categoria_id)' checked='checked'/></td>";
                        echo "<td width='350px'>$ulrFeed</td>";
                        echo "<td width='30px'>".Tag::numericField("limite_$feed_id","value: {$result->getLimiteItems()}","size: 2px")."</td>";
                        echo "</tr>";
                        $array_feeds[]=$feed_id;
                    }
                    //FIN VER LOS RSS ASIGNADOS
                }

                //INICIO VER LOS NO ASIGNADOS
                $feed= new Feed();
                $arma_feeds_id=implode($array_feeds,",");
                if (count($array_feeds)!=0)
                    $buscaFeed= $feed->Find("categoriafeeds_id= $categoria_id AND activo=1 AND id NOT IN($arma_feeds_id)");
                else
                    $buscaFeed= $feed->Find("categoriafeeds_id= $categoria_id AND activo=1");
                foreach ($buscaFeed as $result1) {
                    $feed_id= $result1->getId();
                    $ulrFeed= $result1->getUrlFeed();
                    echo "<tr>";
                    echo "<td width='40px' style='padding-left:8px; padding-right:8px'><input type='checkbox' id='chk_feed' name='chk_feed' value='$feed_id' class='c_feed_$categoria_id' onclick='seleccionar($categoria_id)'/></td>";
                    echo "<td width='350px'>$ulrFeed</td>";
                    echo "<td width='30px'>".Tag::numericField("limite_$feed_id","value: 5","size: 2px")."</td>";
                    echo "</tr>";
                }
                //INICIO VER LOS NO ASIGNADOS
                echo "</table>";
                echo "</div>";
                echo "</td>";
                //echo "<td>".Tag::textField("limite_$categoria_id","value: ","size: 2px")."</td>";
                echo "</tr>";
            }
            ?>
        </tr>
    </table>
</fieldset>
<?php
//echo Tag::textField("total_categorias","value: $i");
?>
<script>

    abrir_div_feeds();
    //abre el div de los feeds de ca categor�a seleccionada
    function abrir_div_feeds(categoria_id){
        var divs=$("div[name^='div_feeds_']");
        for (var x=0; x < divs.length; x++) {
            nombre= divs[x].id;
            $("#"+nombre).hide();
        }
        $("#div_feeds_"+categoria_id).show();
    }

    //cierra el div de los turnos clasificados por servicios
    function cerrar_div_feeds(categoria_id){
        $("#div_feeds_"+categoria_id).hide();
    }

    //seleccionar todos los feeds respectivos de la categoria
    //cada turnos tiene la clase c_feed_ seguido del id de la categoria
    function check_all_feeds(categoria_id){
        var chks=$(".c_feed_"+categoria_id);
        chks.attr("checked","checked");
        seleccionar(categoria_id);
    }

    //deseleccionar todos los feeds respectivos de la categoria
    //cada turnos tiene la clase c_feed_ seguido del id de la categoria
    function uncheck_all_feeds(categoria_id){
        //$("#turnos_id").val("");
        var chks=$(".c_feed_"+categoria_id);
        chks.attr("checked","");
        $("#total_feeds_"+categoria_id).val(0);
        $("#seleccionados_"+categoria_id).val("");
    }

    function seleccionar(categoria_id){
        var chks=$(".c_feed_"+categoria_id);
        var ids="";
        var cont=0;
        for (var x=0; x < chks.length; x++) {
            if (chks[x].checked) {
                ids=ids+chks[x].value+",";
                cont+=1;
            }
        }
        $("#total_feeds_"+categoria_id).val(cont);
        $("#seleccionados_"+categoria_id).val(ids);
    }


    function seleccionarEditar(){
        for(i=1;i<=20;i++){
            var categoria_id=i;
            var chks=$(".c_feed_"+categoria_id);
            var ids="";
            var cont=0;
            for (var x=0; x < chks.length; x++) {
                if (chks[x].checked) {
                    ids=ids+chks[x].value+",";
                    cont+=1;
                }
            }
            $("#total_feeds_"+categoria_id).val(cont);
            $("#seleccionados_"+categoria_id).val(ids);
        }
    }
    seleccionarEditar();

</script>
